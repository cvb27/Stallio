  {% extends "admin/layout.html" %}

  {% block content %}
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-4">
      <h1 class="h4 mb-0">Administrar Órdenes</h1>
      <button class="btn btn-outline-primary btn-sm" onclick="reloadAll()">Recargar todo</button>
    </div>

    <!-- Pendientes -->
  <div class="card shadow mb-4">
    <div class="card-header d-flex align-items-center justify-content-between">
      <h5 class="mb-0">Órdenes / Pagos reportados</h5>
      <button class="btn btn-outline-primary btn-sm" onclick="reloadPending()">Recargar</button>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <!-- CHANGE: columnas actualizadas a multi-ítem -->
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Productos</th>      <!-- CHANGE: antes 1 producto; ahora lista -->
              <th>Ítems</th>          <!-- CHANGE: suma de qty -->
              <th>Monto</th>
              <th>Cliente</th>        <!-- mantenemos -->
              <th style="width:120px;">Acción</th>
            </tr>
          </thead>
          <tbody id="orders-body">
            {# RENDER INICIAL (server-side) #}
            {% for o in orders %}
            <tr data-row-id="{{ o.id }}">
              <td>#{{ o.id }}</td>
              <!-- CHANGE: created_at es ISO string del backend → no usar strftime aquí -->
              <td>{{ o.created_at or '-' }}</td>

              <!-- CHANGE: lista de productos con qty -->
              <td>
                {% if o["items"] and o["items"]|length > 0 %}
                  <ul class="mb-0 small">
                    {% for it in o["items"] %}
                      <li>{{ it.product_name }} × {{ it.qty }}</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  -
                {% endif %}
              </td>

              <!-- CHANGE: total ítems = suma de qty -->
              <td>
                {% set total_qty = 0 %}
                {% for it in o["items"] %}{% set total_qty = total_qty + (it.qty or 0) %}{% endfor %}
                {{ total_qty }}
              </td>

              <td>${{ '%.2f'|format(o.amount or 0) }}</td>
              <td>{{ o.payer_name or '-' }}</td>

              <td>
                <button class="btn btn-success btn-sm" onclick="dispatchOrder({{ o.id }})">
                  <i class="fas fa-check"></i> Despachar
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <small class="text-muted">Se actualiza automáticamente cuando un cliente reporta pago.</small>
    </div>
  </div>

    <!-- Pendientes -->
  <div class="card shadow mb-4">
    <div class="card-header d-flex align-items-center justify-content-between">
      <h5 class="mb-0">Órdenes / Pagos reportados</h5>
      <button class="btn btn-outline-primary btn-sm" onclick="reloadPending()">Recargar</button>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <!-- CHANGE: columnas actualizadas a multi-ítem -->
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Productos</th>      <!-- CHANGE: antes 1 producto; ahora lista -->
              <th>Ítems</th>          <!-- CHANGE: suma de qty -->
              <th>Monto</th>
              <th>Cliente</th>        <!-- mantenemos -->
              <th style="width:120px;">Acción</th>
            </tr>
          </thead>
          <tbody id="orders-body">
            {# RENDER INICIAL (server-side) #}
            {% for o in orders %}
            <tr data-row-id="{{ o.id }}">
              <td>#{{ o.id }}</td>
              <!-- CHANGE: created_at es ISO string del backend → no usar strftime aquí -->
              <td>{{ o.created_at or '-' }}</td>

              <!-- CHANGE: lista de productos con qty -->
              <td>
                {% if o["items"] and o["items"]|length > 0 %}
                  <ul class="mb-0 small">
                    {% for it in o["items"] %}
                      <li>{{ it.product_name }} × {{ it.qty }}</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  -
                {% endif %}
              </td>

              <!-- CHANGE: total ítems = suma de qty -->
              <td>
                {% set total_qty = 0 %}
                {% for it in o["items"] %}{% set total_qty = total_qty + (it.qty or 0) %}{% endfor %}
                {{ total_qty }}
              </td>

              <td>${{ '%.2f'|format(o.amount or 0) }}</td>
              <td>{{ o.payer_name or '-' }}</td>

              <td>
                <button class="btn btn-success btn-sm" onclick="dispatchOrder({{ o.id }})">
                  <i class="fas fa-check"></i> Despachar
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <small class="text-muted">Se actualiza automáticamente cuando un cliente reporta pago.</small>
    </div>
  </div>

  <script>
// === Utils ===
function formatLocal(dtIso){
  if (!dtIso) return "-";
  const d = new Date(dtIso);
  return new Intl.DateTimeFormat(undefined, {
    year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit", hour12: false
  }).format(d).replace(',', '');
}
function money(n){ return "$" + Number(n || 0).toFixed(2); }

// === Helpers de render de items ===
// CHANGE: construye la lista HTML de productos × qty
function renderProductsList(items){
  if (!Array.isArray(items) || !items.length) return "-";
  const lis = items.map(it => `<li>${escapeHtml(it.product_name)} × ${Number(it.qty||0)}</li>`).join("");
  return `<ul class="mb-0 small">${lis}</ul>`;
}
function sumQty(items){
  if (!Array.isArray(items)) return 0;
  return items.reduce((acc, it) => acc + Number(it.qty || 0), 0);
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

// === Recargas ===
async function reloadPending(){
  const r = await fetch("/admin/orders/list.json", { cache: "no-store" });
  const data = await r.json();
  const tb = document.getElementById("orders-body");
  tb.innerHTML = data.map(o => `
    <tr data-row-id="${o.id}">
      <td>#${o.id}</td>
      <td>${formatLocal(o.created_at)}</td>
      <td>${renderProductsList(o.items)}</td>
      <td>${sumQty(o.items)}</td>
      <td>${money(o.amount)}</td>
      <td>${escapeHtml(o.payer_name || "-")}</td>
      <td>
        <button class="btn btn-success btn-sm" onclick="dispatchOrder(${o.id})">
          <i class="fas fa-check"></i> Despachar
        </button>
      </td>
    </tr>
  `).join("");
}

async function reloadDispatched(){
  const r = await fetch("/admin/orders/dispatched.json", { cache: "no-store" });
  const data = await r.json();
  const tb = document.getElementById("dispatched-body");
  tb.innerHTML = data.map(o => `
    <tr data-row-id="${o.id}">
      <td>#${o.id}</td>
      <td>${formatLocal(o.created_at)}</td>
      <td>${renderProductsList(o.items)}</td>
      <td>${sumQty(o.items)}</td>
      <td>${money(o.amount)}</td>
      <td>${escapeHtml(o.payer_name || "-")}</td>
      <td>${formatLocal(o.dispatched_at)}</td>
    </tr>
  `).join("");
}

async function dispatchOrder(id){
  if (!confirm("¿Marcar esta orden como despachada?")) return;
  try{
    const r = await fetch(`/admin/orders/dispatch/${id}`, { method: "POST" });
    const data = await r.json();
    if (data.ok){
      await reloadPending();
      await reloadDispatched();
    }else{
      alert("No se pudo despachar: " + (data.detail || "error"));
    }
  }catch(e){
    alert("Error de red: " + e);
  }
}

function reloadAll(){ reloadPending(); reloadDispatched(); }

// === WebSocket en vivo ===
document.addEventListener("DOMContentLoaded", () => {
  reloadAll();

  if (window.__pubWS) { try { window.__pubWS.close(); } catch(_){} }
  const proto = (location.protocol === "https:") ? "wss" : "ws";
  const ws = new WebSocket(`${proto}://${location.host}/ws/public`);
  window.__pubWS = ws;

  ws.onmessage = async (ev) => {
    try{
      const msg = JSON.parse(ev.data);
      if (msg.type === "payment_reported"){
        await reloadPending();
      } else if (msg.type === "order_dispatched"){
        await reloadPending();
        await reloadDispatched();
      }
    }catch(e){ console.warn(e); }
  };
  window.addEventListener("beforeunload", () => { try { ws.close(); } catch(_){} });
});
</script>
{% endblock %}